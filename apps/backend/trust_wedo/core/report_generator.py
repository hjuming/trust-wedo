"""Report generator module for Trust WEDO."""

import json
from pathlib import Path
from typing import Dict, List, Any
from trust_wedo.utils.meta import get_meta


class ReportGenerator:
    """Generator for final trust reports (MD/JSON)."""

    def __init__(self, bundle_dir: str):
        self.bundle_path = Path(bundle_dir)
        self.data: Dict[str, Any] = {}
        self._load_bundle()

    def _load_bundle(self) -> None:
        """Load all JSON files from bundle."""
        files = {
            "site": "site.json",
            "entity": "entity_profile.json",
            "afb": "afb.json",
            "citation": "citation_eval.json",
            "graph": "entity_graph.json"
        }
        for key, filename in files.items():
            file_path = self.bundle_path / filename
            if file_path.exists():
                with open(file_path) as f:
                    self.data[key] = json.load(f)

    def generate_json(self) -> Dict[str, Any]:
        """Generate aggregated JSON report."""
        return {
            "meta": get_meta(str(self.bundle_path)),
            "summary": {
                "entity_id": self.data.get("entity", {}).get("entity_id"),
                "ec_score": self.data.get("entity", {}).get("entity_confidence"),
                "eligibility": self.data.get("entity", {}).get("eligibility"),
                "citation_decision": self.data.get("citation", {}).get("decision"),
                "risk_detected": self.data.get("graph", {}).get("metrics", {}).get("single_source_risk", False)
            },
            "details": self.data
        }

    def generate_markdown(self) -> str:
        """Generate Markdown report."""
        summary = self.data.get("entity", {})
        citation = self.data.get("citation", {})
        graph = self.data.get("graph", {}).get("metrics", {})
        
        md = f"""# Trust WEDO ä¿¡ä»»è©•ä¼°å ±å‘Š

## 1. å¯¦é«”æ¦‚è¦½
- **å¯¦é«” ID**: `{summary.get('entity_id', 'N/A')}`
- **ä¿¡ä»»è©•åˆ† (EC)**: `{summary.get('entity_confidence', 0.0):.2f}`
- **åˆ¤å®šçµæœ**: `{"âœ… é€šé" if summary.get('eligibility') == 'pass' else "âŒ æ‹’çµ•"}`

### ä¿¡ä»»ä¿¡è™Ÿ
| ä¿¡è™Ÿ | åˆ†æ•¸ |
|------|------|
| Consistency | {summary.get('signals', {}).get('consistency', 0.0)} |
| Authority | {summary.get('signals', {}).get('authority', 0.0)} |
| Citation | {summary.get('signals', {}).get('citation', 0.0)} |
| Frequency | {summary.get('signals', {}).get('frequency', 0.0)} |
| Social | {summary.get('signals', {}).get('social', 0.0)} |

## 2. ç­”æ¡ˆç‰©ä»¶ (AFB)
- **AFB ID**: `{self.data.get('afb', {}).get('afb_id', 'N/A')}`
- **AI å¿«é€Ÿç­”æ¡ˆ**: {self.data.get('afb', {}).get('ai_quick_answer', 'N/A')}

## 3. å¼•ç”¨è©•ä¼°
- **æœ€çµ‚æ±ºç­–**: `{citation.get('decision', 'N/A')}`
- **å¼•ç”¨æ•¸é‡**: {len(citation.get('citations', []))}

## 4. é¢¨éšªæª¢æ¸¬
- **ä¾†æºå¤šæ¨£æ€§**: {graph.get('distinct_sources', 0)}
- **å­¤ç«‹å¯¦é«”**: `{"æ˜¯" if graph.get('is_isolated') else "å¦"}`
- **å–®ä¸€ä¾†æºé¢¨éšª**: `{"ğŸ”´ é«˜" if graph.get('single_source_risk') else "ğŸŸ¢ ä½"}`

---
*Generated by Trust WEDO CLI v0.1.0*
"""
        return md
